#!/usr/bin/env zsh

YABAIRC_FILE=$XDG_CONFIG_HOME/yabai/yabairc

config_rules=$(sed -n '/^typeset -A float=(/,/^)/p' $YABAIRC_FILE)

while IFS=$'\t' read -r index app title; do
  line="  [${(q+)app}]=${title:+${(q+)title}}"
  if ! print -r $config_rules | grep -qF $line; then
    sed 's/\(# Autogenerated rules\)/\1\n'$line'/' <<EOF >$YABAIRC_FILE
$(< $YABAIRC_FILE)
EOF
  fi
done < <(
  yabai -m rule --list |
    jq -r '
      .[]
      | select(.label | startswith("float:"))
      | [.index, .app, .title]
      | @tsv
    '
)
