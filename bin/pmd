#!/bin/sh

sysfs_ac="/sys/class/power_supply/AC"

pm_onac() {
  nvidia-settings -a "[gpu:0]/GpuPowerMizerMode=1"
  #doas cpupower frequency-set -g performance
}

pm_onbattery() {
  nvidia-settings -a "[gpu:0]/GpuPowerMizerMode=0"
  #doas cpupower frequency-set -g powersave
}

ac_status() {
  [ "$(cat "$sysfs_ac/online")" = "1" ]
}

apply() {
  if ac_status; then
    pm_onac
  else
    pm_onbattery
  fi
  "$HOME"/bin/setscreenblank
}

apply
stdbuf -i 0 -o 0 -e 0 udevadm monitor -s power_supply -u | while read _; do
  apply
done
