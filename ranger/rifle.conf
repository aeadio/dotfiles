# vim: ft=cfg

# I primary use ranger as a terminal-first file manager. Default behavior 
# should only ever open file in the terminal. Opening with a GUI application
# should be achieved with a dedicated keybind (via labels). Scripts should
# never be executed as the "open" action.

# o / Enter -> open in terminal
# O -> open in GUI application (label=gopen)
# e -> open in terminal editor (label=editor)
# E -> open in GUI editor      (label=geditor)
# i -> open in pager, as metadata viewer for non-text (label=pager || final fallback)

#-------------------------------------------
# Documentation
#-------------------------------------------
ext 1 = man -- "$1"
label pager, ext 1 = max -- "$1"

#-------------------------------------------
# Text & source files
#-------------------------------------------
# Except above, text and source files should open in editor. Use VISUAL with
# keybinding.
label pager, ext x?html?, has w3m    = w3m "$@"
label pager, ext x?html?, has lynx   = lynx -- "$@"
label pager, ext x?html?, has elinks = elinks -- "$@"
label pager, ext x?html?, has pandoc = pandoc -s -t markdown -- "$@" | "${PAGER:-less}"
label pager, ext json, has jq,       = jq '' -- "$@" | "${PAGER:-less}"

mime ^text, label editor               = "${EDITOR:-vi}" -- "$@"
mime ^text, label geditor, env VISUAL  = "$VISUAL" -- "$@"
mime ^text, label geditor, X, has open = open -t -- "$@"
mime ^text, label pager                = "${PAGER:-less}" -- "$@"
mime ^text, label gopen, env VISUAL    = "$VISUAL" -- "$@"
mime ^text                             = "${EDITOR:-vi}" -- "$@"

# Source file that may not match mimetype ^text,
# XXX: more source extensions. Check mime spec for how they are categorized
ext xml|json|csv|tex|py|pl|rb|js|sh|php, label editor               = "${EDITOR:-vi}" -- "$@"
ext xml|json|csv|tex|py|pl|rb|js|sh|php, label geditor, env VISUAL  = "$VISUAL" -- "$@"
ext xml|json|csv|tex|py|pl|rb|js|sh|php, label geditor, X, has open = open -t -- "$@"
ext xml|json|csv|tex|py|pl|rb|js|sh|php, label pager                = "${PAGER:-less}" -- "$@"
ext xml|json|csv|tex|py|pl|rb|js|sh|php, label gopen, env VISUAL    = "$VISUAL" -- "$@"
ext xml|json|csv|tex|py|pl|rb|js|sh|php                             = "${EDITOR:-vi}" -- "$@"

#--------------------------------------------
# Audio
#-------------------------------------------
mime ^audio|ogg$, has mocp,         terminal = mocp -- "$@"
mime ^audio|ogg$, has nvlc,         terminal = nvlc -- "$@"
mime ^audio|ogg$, has mpv,          terminal = mpv --force-window=no -- "$@"
mime ^audio|ogg$, has mplayer,      terminal = mplayer -- "$@"
mime ^audio|ogg$, has mplayer,      terminal = mplayer2 -- "$@"
mime ^audio|ogg$, has cvlc,         terminal = cvlc -I ncurses -- "$@"
mime ^audio|ogg$, has play,         terminal = play -- "$@"
mime ^audio|ogg$, has ffplay,       terminal = ffplay -autoexit -- "$@"
mime ^audio|ogg$, has afplay,       terminal = afplay -- "$@"
mime ^audio|ogg$, has paplay,       terminal = paplay -- "$@"
mime ^audio|ogg$, has gst-play-1.0, terminal = gst-play-1.0 -- "$@"
ext mp3,          has mpg123,       terminal = mpg123 -- "$@"
ext ogg,          has ogg123,       terminal = ogg123 -- "$@"
ext wav,          has aplay,        terminal = aplay -- "$@"

label pager, mime ^audio|ogg$, has mediainfo = mediainfo -- "$@" | "${PAGER:-less}"

#-------------------------------------------
# Documents
#-------------------------------------------
ext epub|epub3|fb2|mobi|azw3, has epy, terminal = epy  -- "$@"
ext epub,            has epr,          terminal = epr  -- "$@"
ext epub,            has bk,           terminal = bk   -- "$@"
ext epub,            has epub,         terminal = epub -- "$@"
ext pdf,             has pdftotext,    terminal = pdftotext   -- "$@" | "${PAGER:-less}"
ext docx?|rtf,       has catdoc,       terminal = catdoc      -- "$@" | "${PAGER:-less}"
ext xlsx?,           has xlsx2csv,     terminal = xlsx2csv    -- "$@" | "${PAGER:-less}"
ext xlsx?,           has xls2csv,      terminal = xls2csv     -- "$@" | "${PAGER:-less}"
ext odt|ods|odp|sxw, has wordgringer,  terminal = wordgringer -- "$@"
ext odt|ods|odp|sxw, has odt2txt,      terminal = odt2txt     -- "$@" | "${PAGER:-less}"
ext odt|ods|odp|sxw, has pandoc,       terminal = pandoc -s -t markdown -- "$@" | "${PAGER:-less}"

label pager, ext pdf,   has pdftotext,         terminal = pdftotext -- "$@" | "${PAGER:-less}"
label pager, ext docx?|rtf, has catdoc,        terminal = catdoc    -- "$@" | "${PAGER:-less}"
label pager, ext xlsx?, has xlsx2csv,          terminal = xlsx2csv  -- "$@" | "${PAGER:-less}"
label pager, ext xlsx?, has xls2csv,           terminal = xls2csv   -- "$@" | "${PAGER:-less}"
label pager, ext odt|ods|odp|sxw, has odt2txt, terminal = odt2txt   -- "$@" | "${PAGER:-less}"
label pager, ext odt|ods|odp|sxw, has pandoc,  terminal = pandoc -s -t markdown -- "$@" | "${PAGER:-less}"

#-------------------------------------------
# Video
#-------------------------------------------
label pager, mime ^video$, has mediainfo = mediainfo -- "$@" | "${PAGER:-less}"

#-------------------------------------------
# Images
#-------------------------------------------
label pager, mime ^image$, has exiftool = exiftool -- "$@" | "${PAGER:-less}"

#-------------------------------------------
# Archives
#-------------------------------------------
# Do not extract by default. Allow the user to browse the contents unless they
# invoke extract via label.

# List/browse archives

ext 001|7z|a|apm|ar|arj|bz(ip)?2?|cab|ch(i|m|q|w)|cpio, has 7z = 7z l -- "$1" | "${PAGER:-less}"
ext cramfs|deb|dmg|esd|ext(2|3|4)?|fat|gz(ip)?|hfsx?,   haz 7z = 7z l -- "$1" | "${PAGER:-less}"
ext hx(i|q|r|s|w)|ihex|img|iso|lib|lha|lz(h|ma)|mbr,    haz 7z = 7z l -- "$1" | "${PAGER:-less}"
ext msi|mslz|msp|nsis|ntfs|qcow(2|2c)?|rar|r00|rpm,     haz 7z = 7z l -- "$1" | "${PAGER:-less}"
ext pkg|ppmd|scap|swm|tar|taz|tbz2?|tgz|udf|eufif,      haz 7z = 7z l -- "$1" | "${PAGER:-less}"
ext vdi|vhdx?|vmdk|wim|xar|xz|z|zip,                    haz 7z = 7z l -- "$1" | "${PAGER:-less}"

ext ace|ar|arc|bz2?|bzip2?|cab|cpio|cpt|deb|dgc|dmg|gz, has atool = atool --list --each -- "$@" | "${PAGER:-less}"
ext iso|jar|msi|pkg|rar|shar|tar|tgz|xar|xpi|xz|zip,    has atool = atool --list --each -- "$@" | "${PAGER:-less}"

ext tar|tbz2?|tgz|gz|txz|bz2|xz, has tar = tar vvtf -- "$1" | "${PAGER:-less}"

ext zip,   has unzip = unzip -l -- "$1" | "${PAGER:-less}"
ext ace,   has unace = unace l  -- "$1" | "${PAGER:-less}"
ext rar,   has rar   = rar l    -- "$1" | "${PAGER:-less}"
ext rar,   has unrar = unrar l  -- "$1" | "${PAGER:-less}"
ext zstd?, has zstd  = zstd -lv -- "$1" | "{PAGER:-less}"

# List/browse archives -- pager action

label pager, ext 001|7z|a|apm|ar|arj|bz(ip)?2?|cab|ch(i|m|q|w)|cpio, has 7z = 7z l -- "$1" | "${PAGER:-less}"
label pager, ext cramfs|deb|dmg|esd|ext(2|3|4)?|fat|gz(ip)?|hfsx?,   haz 7z = 7z l -- "$1" | "${PAGER:-less}"
label pager, ext hx(i|q|r|s|w)|ihex|img|iso|lib|lha|lz(h|ma)|mbr,    haz 7z = 7z l -- "$1" | "${PAGER:-less}"
label pager, ext msi|mslz|msp|nsis|ntfs|qcow(2|2c)?|rar|r00|rpm,     haz 7z = 7z l -- "$1" | "${PAGER:-less}"
label pager, ext pkg|ppmd|scap|swm|tar|taz|tbz2?|tgz|udf|eufif,      haz 7z = 7z l -- "$1" | "${PAGER:-less}"
label pager, ext vdi|vhdx?|vmdk|wim|xar|xz|z|zip,                    haz 7z = 7z l -- "$1" | "${PAGER:-less}"

label pager, ext ace|ar|arc|bz2?|bzip2?|cab|cpio|cpt|deb|dgc|dmg|gz, has atool = atool --list --each -- "$@" | "${PAGER:-less}"
label pager, ext iso|jar|msi|pkg|rar|shar|tar|tgz|xar|xpi|xz|zip,    has atool = atool --list --each -- "$@" | "${PAGER:-less}"

label pager, ext tar|tbz2?|tgz|gz|txz|bz2|xz, has tar = tar vvtf -- "$1" | "${PAGER:-less}"

label pager, ext zip,   has unzip = unzip -l -- "$1" | "${PAGER:-less}"
label pager, ext ace,   has unace = unace l  -- "$1" | "${PAGER:-less}"
label pager, ext rar,   has rar   = rar l    -- "$1" | "${PAGER:-less}"
label pager, ext rar,   has unrar = unrar l  -- "$1" | "${PAGER:-less}"
label pager, ext zstd?, has zstd  = zstd -lv -- "$1" | "{PAGER:-less}"

# Extract archives
# Give a terminal to tools which support password prompts

label extract, ext tar|tbz2?|tgz|txz|gz|bz2|xz, has tar = for file in "$@"; do tar vvxf -- "$file"; done

label extract, ext bz2,   has bzip2           = for file in "$@"; do bzip2 -dk -- "$file"; done
label extract, ext zip,   has unzip, terminal = for file in "$@"; do unzip -d  -- "${file%.*}" "$file"; done
label extract, ext ace,   has unace           = for file in "$@"; do unace e   -- "$file"; done
label extract, ext rar,   has unrar, terminal = for file in "$@"; do unrar x   -- "$file"; done
label extract, ext rar,   has rar,   terminal = for file in "$@"; do rar x   -- "$file"; done
label extract, ext zstd?, has zstd            = for file in "$@"; do zstd -d   -- "$file"; done

label extract, ext 001|7z|a|apm|ar|arj|bz(ip)?2?|cab|ch(i|m|q|w)|cpio, has 7z, terminal = for file in "$@"; do 7z x -- "$file"; done
label extract, ext cramfs|deb|dmg|esd|ext(2|3|4)?|fat|gz(ip)?|hfsx?,   haz 7z, terminal = for file in "$@"; do 7z x -- "$file"; done
label extract, ext hx(i|q|r|s|w)|ihex|img|iso|lib|lha|lz(h|ma)|mbr,    haz 7z, terminal = for file in "$@"; do 7z x -- "$file"; done
label extract, ext msi|mslz|msp|nsis|ntfs|qcow(2|2c)?|rar|r00|rpm,     haz 7z, terminal = for file in "$@"; do 7z x -- "$file"; done
label extract, ext pkg|ppmd|scap|swm|tar|taz|tbz2?|tgz|txz|udf|eufif,  haz 7z, terminal = for file in "$@"; do 7z x -- "$file"; done
label extract, ext vdi|vhdx?|vmdk|wim|xar|xz|z|zip,                    haz 7z, terminal = for file in "$@"; do 7z x -- "$file"; done

#-------------------------------------------
# Misc
#-------------------------------------------
ext torrent, has transmission-show = transmission-show -- "$@"
label pager, ext torrent, has transmission-show = transmission-show -- "$@"

#-------------------------------------------
# GUI catchalls
#-------------------------------------------
label gopen, X, has xdg-open = xdg-open -- "$@"
label gopen, X, has open     = open -- "$@"
label geditor, env VISUAL    = "$VISUAL" -- "$@"
label geditor, X, has open   = open -t -- "$@"

######################################################################
# The actions below are left so low down in this file on purpose, so #
# they are never triggered accidentally.                             #
######################################################################

# Move the file to trash
label trash, has trash-put                         = trash-put -- "$@"
label trash, has launchd, has sw_vers, has recycle = recycle -- "$@"
label trash, has launchd, has sw_vers, has trash   = trash -- "$@"
label trash, has launchd, has sw_vers = mkdir -p -- "$HOME/.Trash" && mv -- "$@" "$HOME/.Trash/"
label trash = mkdir -p -- "${XDG_DATA_HOME:-$HOME/.local/share}/Trash" && mv -- "$@" "${XDG_DATA_HOME:-$HOME/.local/share}/Trash/"

#-------------------------------------------
# Finally
#-------------------------------------------
else = ask
